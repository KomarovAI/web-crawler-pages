name: ğŸŒ Deploy to Pages

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (KomarovAI/web-crawler)'
        required: true
        default: 'KomarovAI/web-crawler'
      run_id:
        description: 'Workflow run ID from web-crawler (look at Actions tab)'
        required: true
      site_domain:
        description: 'Domain folder name (e.g., callmedley-com)'
        required: true
        default: 'callmedley-com'

jobs:
  # ============================================================
  # JOB 1: VERIFY - Check database integrity
  # ============================================================
  verify:
    name: 'ğŸ” Verify Database'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âœ… Check database files
        run: |
          python3 << 'EOF'
          import sqlite3
          from pathlib import Path
          import sys
          
          artifacts_dir = Path('artifacts')
          db_files = list(artifacts_dir.glob('db-*/*.db'))
          
          print(f"\nğŸ” Searching in: {artifacts_dir}")
          print(fğŸ“‚ Directory contents: {list(artifacts_dir.iterdir())}")
          
          if not db_files:
            print("âŒ No database files found!")
            print("âš ï¸  Make sure:")
            print("  1. Run ID is CORRECT (from web-crawler Actions tab)")
            print("  2. That run has completed successfully")
            print("  3. Artifacts were uploaded")
            sys.exit(1)
          
          print(f"\nâœ… Found {len(db_files)} database(s)\n")
          
          for db_file in sorted(db_files):
            domain = db_file.parent.name.replace('db-', '')
            size_mb = db_file.stat().st_size / 1024 / 1024
            
            print(f"ğŸ“¦ {domain} ({size_mb:.2f} MB)")
            
            # Check SQLite format
            with open(db_file, 'rb') as f:
              if f.read(16) != b'SQLite format 3':
                print(f"  âŒ Invalid SQLite format!")
                sys.exit(1)
            
            # Connect and verify
            try:
              conn = sqlite3.connect(str(db_file))
              cursor = conn.cursor()
              
              cursor.execute("SELECT COUNT(*) FROM pages")
              pages = cursor.fetchone()[0]
              print(f"  âœ… Pages: {pages}")
              
              cursor.execute("PRAGMA integrity_check")
              if cursor.fetchone()[0] != 'ok':
                print(f"  âŒ Database corrupted!")
                sys.exit(1)
              
              print(f"  âœ… Integrity: OK")
              conn.close()
              
            except Exception as e:
              print(f"  âŒ Error: {e}")
              sys.exit(1)
          
          print("\nâœ… All databases verified!\n")
          EOF

  # ============================================================
  # JOB 2: BUILD - Convert database to HTML
  # ============================================================
  build:
    name: 'ğŸ—ï¸ Build HTML'
    needs: verify
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ—ï¸ Build HTML pages
        run: |
          python3 << 'EOF'
          import sqlite3
          import shutil
          from pathlib import Path
          from datetime import datetime
          
          artifacts_dir = Path('artifacts')
          output_dir = Path('sites')
          output_dir.mkdir(exist_ok=True)
          
          print("\n" + "="*60)
          print("ğŸ—ï¸  BUILDING STATIC SITE")
          print("="*60 + "\n")
          
          for db_dir in sorted(artifacts_dir.glob('db-*')):
            domain_folder = db_dir.name.replace('db-', '')
            db_file = db_dir / f"{domain_folder}.db"
            
            if not db_file.exists():
              continue
            
            print(f"ğŸ“¦ Building: {domain_folder}")
            
            site_dir = output_dir / domain_folder
            site_dir.mkdir(exist_ok=True)
            pages_dir = site_dir / 'pages'
            pages_dir.mkdir(exist_ok=True)
            
            shutil.copy(db_file, site_dir / f"{domain_folder}.db")
            
            conn = sqlite3.connect(str(db_file))
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            cursor.execute("SELECT id, url, title, content, status_code FROM pages ORDER BY id")
            pages = cursor.fetchall()
            
            print(f"  ğŸ“„ {len(pages)} pages")
            
            # Create index page
            index_html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{domain_folder}</title>
            <style>
              * {{ margin: 0; padding: 0; box-sizing: border-box; }}
              body {{ 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 40px 20px;
              }}
              .container {{ max-width: 1200px; margin: 0 auto; }}
              h1 {{ color: white; text-align: center; margin-bottom: 40px; font-size: 2.5em; }}
              .grid {{ display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }}
              .card {{
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                transition: transform 0.2s;
              }}
              .card:hover {{ transform: translateY(-5px); }}
              .card h3 {{ color: #333; margin-bottom: 10px; }}
              .card p {{ color: #666; font-size: 0.9em; word-break: break-all; }}
              .card a {{
                display: inline-block;
                margin-top: 15px;
                padding: 8px 12px;
                background: #667eea;
                color: white;
                text-decoration: none;
                border-radius: 4px;
              }}
              .card a:hover {{ background: #764ba2; }}
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸ“¦ {domain_folder}</h1>
              <div class="grid">
          """
            
            for idx, page in enumerate(pages, 1):
              page_num = f"{idx:05d}"
              title = (page['title'] or 'Untitled')[:40]
              url = page['url'][:60]
              status = page['status_code']
              
              index_html += f"""              <div class="card">
                <h3>{title}</h3>
                <p>{url}</p>
                <small>Status: {status}</small>
                <a href="pages/page-{page_num}.html">View â†’</a>
              </div>
          """
            
            index_html += f"""              </div>
            </div>
          </body>
          </html>"""
            
            with open(site_dir / 'index.html', 'w', encoding='utf-8') as f:
              f.write(index_html)
            
            # Create individual page files
            for idx, page in enumerate(pages, 1):
              page_num = f"{idx:05d}"
              page_file = pages_dir / f"page-{page_num}.html"
              
              page_html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{(page['title'] or 'Page')[:50]}</title>
            <style>
              * {{ margin: 0; padding: 0; box-sizing: border-box; }}
              body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }}
              .container {{ max-width: 900px; margin: 0 auto; background: white; padding: 30px; }}
              .header {{ border-bottom: 2px solid #667eea; margin-bottom: 30px; }}
              .header h1 {{ color: #667eea; }}
              .meta {{ color: #666; font-size: 0.9em; margin: 5px 0; }}
              .nav a {{ display: inline-block; padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; }}
              .nav a:hover {{ background: #764ba2; }}
            </style>
          </head>
          <body>
            <div class="container">
              <div class="nav" style="margin-bottom: 20px;">
                <a href="../index.html">â† Back</a>
              </div>
              <div class="header">
                <h1>{(page['title'] or 'Page')[:50]}</h1>
                <div class="meta"><b>URL:</b> {page['url']}</div>
                <div class="meta"><b>Status:</b> {page['status_code']}</div>
              </div>
              <div style="margin-top: 30px; line-height: 1.8;">
          {(page['content'] or '')[:5000]}
              </div>
            </div>
          </body>
          </html>"""
              
              with open(page_file, 'w', encoding='utf-8') as f:
                f.write(page_html)
            
            conn.close()
            print(f"  âœ… Done\n")
          
          print("="*60)
          print("âœ… Build complete!")
          print("="*60)
          EOF

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: sites-build
          path: sites/
          retention-days: 1

  # ============================================================
  # JOB 3: DEPLOY - Upload to GitHub Pages
  # ============================================================
  deploy:
    name: 'ğŸš€ Deploy to Pages'
    needs: build
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
    
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: sites-build
          path: sites/

      - name: ğŸ”§ Configure Pages
        uses: actions/configure-pages@v4

      - name: ğŸ—ï¸ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: ğŸ“Š Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âœ… DEPLOYMENT SUCCESSFUL                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“– Details:"
          echo "  â€¢ Domain: ${{ inputs.site_domain }}"
          echo "  â€¢ Source: ${{ inputs.source_repo }}"
          echo "  â€¢ Run ID: ${{ inputs.run_id }}"
          echo "  â€¢ Workflow: ${{ github.run_id }}"
          echo ""
          echo "ğŸŒ Pages URL:"
          echo "  https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "âœ¨ Your sites are LIVE!"
          echo ""
