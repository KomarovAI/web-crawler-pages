name: ğŸŒ Deploy Crawled Sites

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'KomarovAI/web-crawler'
      run_id:
        description: 'Workflow run ID to download artifacts from'
        required: true
      site_domain:
        description: 'Domain name for folder (e.g., callmedley-com)'
        required: true
        default: 'callmedley-com'
      skip_verify:
        description: 'Skip verification (NOT RECOMMENDED)'
        required: false
        type: boolean
        default: false
      rollback_mode:
        description: 'Rollback to previous deployment instead of deploy'
        required: false
        type: boolean
        default: false

jobs:
  # ============================================================
  # STEP 1: VERIFY - Full database validation
  # ============================================================
  verify:
    name: 'ğŸ” Verify Artifacts'
    runs-on: ubuntu-24.04
    if: inputs.rollback_mode == false && inputs.skip_verify == false
    permissions:
      contents: read
      actions: read
    outputs:
      status: ${{ steps.final.outputs.status }}
      page_count: ${{ steps.verify.outputs.page_count }}
      artifact_hash: ${{ steps.verify.outputs.artifact_hash }}
    
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ” Verify Database
        id: verify
        run: python3 << 'VERIFY_SCRIPT'
import sqlite3
import hashlib
from pathlib import Path

print("\n" + "="*60)
print("ğŸ” DATABASE VERIFICATION")
print("="*60 + "\n")

artifacts_dir = Path('artifacts')
db_files = list(artifacts_dir.glob('db-*/*.db'))

if not db_files:
  print("âŒ No database files found!")
  exit(1)

print(f"ğŸ“¦ Found {len(db_files)} database(s)\n")

total_pages = 0
errors = []

for db_file in sorted(db_files):
  domain = db_file.parent.name.replace('db-', '')
  size_mb = db_file.stat().st_size / 1024 / 1024
  
  print(f"Domain: {domain} ({size_mb:.2f} MB)")
  
  try:
    with open(db_file, 'rb') as f:
      if f.read(16) != b'SQLite format 3':
        print(f"  âŒ Invalid SQLite format")
        exit(1)
    
    conn = sqlite3.connect(str(db_file))
    cursor = conn.cursor()
    
    # Check pages table
    cursor.execute("SELECT COUNT(*) FROM pages")
    pages = cursor.fetchone()[0]
    total_pages += pages
    print(f"  âœ… Pages: {pages}")
    
    # Check integrity
    cursor.execute("PRAGMA integrity_check")
    if cursor.fetchone()[0] != 'ok':
      print(f"  âŒ Corrupted")
      exit(1)
    print(f"  âœ… Integrity: OK")
    
    conn.close()
  
  except Exception as e:
    print(f"  âŒ Error: {e}")
    errors.append(str(e))

if errors:
  print(f"\nâŒ {len(errors)} error(s) found")
  exit(1)

# Calculate hash
sha256 = hashlib.sha256()
for db_file in sorted(db_files):
  with open(db_file, 'rb') as f:
    for chunk in iter(lambda: f.read(4096), b''):
      sha256.update(chunk)
artifact_hash = sha256.hexdigest()

print(f"\n{'='*60}")
print(f"âœ… Pages verified: {total_pages}")
print(f"âœ… Hash: {artifact_hash[:16]}...")
print(f"{'='*60}\n")

with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
  f.write(f"page_count={total_pages}\n")
  f.write(f"artifact_hash={artifact_hash}\n")
VERIFY_SCRIPT
        env:
          GITHUB_OUTPUT: ${{ github.output }}

      - name: âœ… Verification Complete
        id: final
        run: echo "status=verified" >> $GITHUB_OUTPUT

  # ============================================================
  # STEP 2: BUILD - Convert database to HTML
  # ============================================================
  build:
    name: 'ğŸ—ï¸ Build Static Site'
    needs: [verify]
    if: |
      (inputs.rollback_mode == false) &&
      (inputs.skip_verify == false && needs.verify.result == 'success' ||
       inputs.skip_verify == true)
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read
    outputs:
      build_status: success
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ—ï¸ Build HTML
        run: python3 << 'BUILD_SCRIPT'
import sqlite3
import json
import shutil
from pathlib import Path
from datetime import datetime

print("\n" + "="*60)
print("ğŸ—ï¸ BUILDING STATIC SITE")
print("="*60 + "\n")

artifacts_dir = Path('artifacts')
output_dir = Path('sites')
output_dir.mkdir(exist_ok=True)

for db_dir in sorted(artifacts_dir.glob('db-*')):
  domain_folder = db_dir.name.replace('db-', '')
  db_file = db_dir / f"{domain_folder}.db"
  
  if not db_file.exists():
    continue
  
  print(f"ğŸ“¦ Building: {domain_folder}")
  
  site_dir = output_dir / domain_folder
  site_dir.mkdir(exist_ok=True)
  pages_dir = site_dir / 'pages'
  pages_dir.mkdir(exist_ok=True)
  
  shutil.copy(db_file, site_dir / f"{domain_folder}.db")
  
  conn = sqlite3.connect(str(db_file))
  conn.row_factory = sqlite3.Row
  cursor = conn.cursor()
  
  cursor.execute("SELECT id, url, title, content, status_code FROM pages ORDER BY id")
  pages = cursor.fetchall()
  
  print(f"  ğŸ“„ Processing {len(pages)} pages...")
  
  for idx, page in enumerate(pages, 1):
    page_num = f"{idx:05d}"
    page_file = pages_dir / f"page-{page_num}.html"
    
    html = f"""
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>{page['title'] or page['url']}</title>
      <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }}
        .container {{ max-width: 900px; margin: 0 auto; background: white; padding: 30px; }}
        .header {{ border-bottom: 2px solid #667eea; margin-bottom: 30px; padding-bottom: 20px; }}
        .header h1 {{ color: #667eea; margin-bottom: 10px; }}
        .meta {{ color: #666; font-size: 0.9em; margin: 5px 0; }}
        .content {{ margin: 30px 0; line-height: 1.8; }}
        .nav {{ margin-bottom: 20px; }}
        .nav a {{ display: inline-block; margin-right: 10px; padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; }}
        .nav a:hover {{ background: #764ba2; }}
      </style>
    </head>
    <body>
      <div class="container">
        <div class="nav">
          <a href="../index.html">â† Back</a>
        </div>
        <div class="header">
          <h1>{page['title'] or 'Page'}</h1>
          <div class="meta"><strong>URL:</strong> {page['url']}</div>
          <div class="meta"><strong>Status:</strong> {page['status_code']}</div>
          <div class="meta"><strong>Page:</strong> {idx}/{len(pages)}</div>
        </div>
        <div class="content">
          {(page['content'] or '')[:5000]}
        </div>
      </div>
    </body>
    </html>
    """
    
    with open(page_file, 'w', encoding='utf-8') as f:
      f.write(html)
  
  # Create site index
  index_html = f"""
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{domain_folder}</title>
    <style>
      * {{ margin: 0; padding: 0; box-sizing: border-box; }}
      body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }}
      .container {{ max-width: 1200px; margin: 0 auto; }}
      h1 {{ color: white; text-align: center; margin-bottom: 40px; }}
      .grid {{ display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }}
      .card {{ background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }}
      .card h3 {{ color: #333; margin-bottom: 8px; }}
      .card p {{ color: #666; font-size: 0.9em; margin-bottom: 10px; word-break: break-all; }}
      .card a {{ display: inline-block; padding: 8px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; margin-top: 10px; }}
      .card a:hover {{ background: #764ba2; }}
      .back {{ text-align: center; margin: 30px 0; }}
      .back a {{ color: white; text-decoration: none; padding: 10px 20px; border: 2px solid white; border-radius: 4px; }}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“¦ {domain_folder}</h1>
      <div class="grid">
  """
  
  for idx, page in enumerate(pages, 1):
    page_num = f"{idx:05d}"
    index_html += f"""
      <div class="card">
        <h3>{(page['title'] or 'Untitled')[:30]}</h3>
        <p>{page['url'][:50]}</p>
        <small>Status: {page['status_code']}</small>
        <br>
        <a href="pages/page-{page_num}.html">View â†’</a>
      </div>
    """
  
  index_html += """
      </div>
      <div class="back">
        <a href="../index.html">â† All Sites</a>
      </div>
    </div>
  </body>
  </html>
  """
  
  with open(site_dir / 'index.html', 'w', encoding='utf-8') as f:
    f.write(index_html)
  
  conn.close()
  print(f"  âœ… Done ({len(pages)} pages)\n")

print("="*60)
print("âœ… Build complete!")
print("="*60 + "\n")
BUILD_SCRIPT

      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-site
          path: sites/
          retention-days: 7

  # ============================================================
  # STEP 3: DEPLOY - Upload to GitHub Pages
  # ============================================================
  deploy:
    name: 'ğŸš€ Deploy to GitHub Pages'
    needs: [build]
    if: needs.build.result == 'success'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¥ Download Built Site
        uses: actions/download-artifact@v4
        with:
          name: static-site
          path: sites/

      - name: ğŸ“ Create Metadata
        run: |
          mkdir -p .deployment
          cat > .deployment/info.json << 'EOF'
          {
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployment_id": "${{ github.run_id }}",
            "source_repo": "${{ inputs.source_repo }}",
            "source_run_id": "${{ inputs.run_id }}",
            "domain": "${{ inputs.site_domain }}"
          }
          EOF

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ—ï¸ Build Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: ğŸš€ Deploy
        uses: actions/deploy-pages@v4

  # ============================================================
  # STEP 4: ROLLBACK - Revert to previous deployment
  # ============================================================
  rollback:
    name: 'ğŸ”„ Rollback'
    if: inputs.rollback_mode == true
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
    
    steps:
      - name: ğŸ“¥ Checkout Previous
        uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: ğŸ”„ Get Previous Commit
        run: |
          echo "ğŸ”„ Rolling back to previous deployment..."
          git log --oneline | head -5
          PREV=$(git log --oneline | head -2 | tail -1 | awk '{print $1}')
          git checkout $PREV -- sites/ 2>/dev/null || true

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ—ï¸ Build Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: ğŸš€ Deploy Rollback
        uses: actions/deploy-pages@v4

  # ============================================================
  # STEP 5: SUMMARY - Print results
  # ============================================================
  summary:
    name: 'ğŸ“Š Summary'
    runs-on: ubuntu-24.04
    if: always()
    
    steps:
      - name: ğŸ“Š Print Summary
        run: |
          if [ "${{ inputs.rollback_mode }}" = "true" ]; then
            echo "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ğŸ”„ ROLLBACK EXECUTED                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            "
          else
            echo "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… DEPLOYMENT COMPLETE                            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Details:
            â€¢ Domain: ${{ inputs.site_domain }}
            â€¢ Source: ${{ inputs.source_repo }}
            â€¢ Run ID: ${{ inputs.run_id }}
            â€¢ Workflow: ${{ github.run_id }}
            â€¢ Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ğŸŒ Pages URL:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          
          âœ¨ Your sites are LIVE!
            "
          fi
