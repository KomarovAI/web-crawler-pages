name: ğŸŒ Deploy to Pages

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (KomarovAI/web-crawler)'
        required: true
        default: 'KomarovAI/web-crawler'
      run_id:
        description: 'Workflow run ID from web-crawler Actions tab - URL format: https://github.com/KomarovAI/web-crawler/actions/runs/[RUN_ID] (use the number after /runs/, NOT the job ID)'
        required: true
      site_domain:
        description: 'Domain folder name (e.g., callmedley-com)'
        required: true
        default: 'callmedley-com'

jobs:
  # ============================================================
  # JOB 1: VERIFY - Check database integrity
  # ============================================================
  verify:
    name: 'ğŸ” Verify Database'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GH_PAT }}

      - name: ğŸ—œï¸ Extract ZIP archives recursively
        run: |
          echo "=== EXTRACTING ZIP FILES ==="
          for i in {1..5}; do
            echo "Pass $i:"
            found=0
            find artifacts -name "*.zip" -type f 2>/dev/null | while read zip; do
              found=$((found+1))
              dir=$(dirname "$zip")
              echo "  Extracting: $zip"
              unzip -q -o "$zip" -d "$dir" || true
              rm "$zip"
            done
            if [ $found -eq 0 ]; then
              echo "  No more ZIP files found"
              break
            fi
          done
          
          echo ""
          echo "=== FINAL STRUCTURE ==="
          find artifacts -type f -exec file {} \;

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âœ… Check database files & schema
        run: |
          python3 << 'EOF'
          import sqlite3
          from pathlib import Path
          import sys
          import subprocess
          
          artifacts_dir = Path('artifacts')
          
          print(f"\nğŸ” Searching in: {artifacts_dir}")
          
          if not artifacts_dir.exists():
            print(f"âŒ Artifacts directory does not exist!")
            sys.exit(1)
          
          print(f"ğŸ“‚ Directory contents: {list(artifacts_dir.iterdir())}")
          
          db_files = list(artifacts_dir.glob('**/*.db'))
          
          if not db_files:
            print("âŒ No database files found!")
            sys.exit(1)
          
          print(f"\nâœ… Found {len(db_files)} database(s)\n")
          
          for db_file in sorted(db_files):
            domain = db_file.stem
            size_mb = db_file.stat().st_size / 1024 / 1024
            
            print(f"ğŸ“¦ {domain} ({size_mb:.2f} MB)")
            
            result = subprocess.run(['file', str(db_file)], capture_output=True, text=True)
            file_type = result.stdout.strip()
            print(f"  File type: {file_type}")
            
            with open(db_file, 'rb') as f:
              magic4 = f.read(4)
              if magic4 == b'PK\x03\x04':
                print(f"  âš ï¸  This is actually a ZIP file! Extracting...")
                parent_dir = db_file.parent
                subprocess.run(['unzip', '-q', '-o', str(db_file), '-d', str(parent_dir)])
                db_file.unlink()
                db_files_after = list(parent_dir.glob('*.db'))
                if db_files_after:
                  db_file = db_files_after[0]
                  print(f"  âœ… Extracted to: {db_file}")
                else:
                  print(f"  âŒ No DB file found after extraction!")
                  sys.exit(1)
            
            with open(db_file, 'rb') as f:
              sqlite_magic = f.read(16)
              if sqlite_magic != b'SQLite format 3\x00':
                print(f"  âŒ Invalid SQLite format!")
                print(f"     First 16 bytes (hex): {sqlite_magic.hex()}")
                sys.exit(1)
            
            try:
              conn = sqlite3.connect(str(db_file))
              cursor = conn.cursor()
              
              cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
              tables = cursor.fetchall()
              print(f"  ğŸ“„ Tables: {[t[0] for t in tables]}")
              
              cursor.execute("PRAGMA table_info(pages)")
              columns = cursor.fetchall()
              print(f"  ğŸ“‹ Columns: {[c[1] for c in columns]}")
              
              cursor.execute("SELECT COUNT(*) FROM pages")
              pages = cursor.fetchone()[0]
              print(f"  âœ… Pages: {pages}")
              
              cursor.execute("PRAGMA integrity_check")
              if cursor.fetchone()[0] != 'ok':
                print(f"  âŒ Database corrupted!")
                sys.exit(1)
              
              print(f"  âœ… Integrity: OK")
              conn.close()
              
            except Exception as e:
              print(f"  âŒ Error: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          print("\nâœ… All databases verified!\n")
          EOF

  # ============================================================
  # JOB 2: BUILD - Convert database to HTML
  # ============================================================
  build:
    name: 'ğŸ—ï¸ Build HTML'
    needs: verify
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GH_PAT }}

      - name: ğŸ—œï¸ Extract ZIP archives recursively
        run: |
          for i in {1..5}; do
            find artifacts -name "*.zip" -type f 2>/dev/null | while read zip; do
              dir=$(dirname "$zip")
              unzip -q -o "$zip" -d "$dir" || true
              rm "$zip"
            done
          done

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ—ï¸ Build HTML pages
        run: |
          python3 << 'EOF'
          import sqlite3
          import shutil
          from pathlib import Path
          
          artifacts_dir = Path('artifacts')
          output_dir = Path('_site')  # âœ… Ğ¤Ğ˜ĞšĞ¡: ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
          output_dir.mkdir(exist_ok=True)
          
          print("\n" + "="*60)
          print("ğŸ—ï¸  BUILDING STATIC SITE")
          print("="*60 + "\n")
          
          db_files = list(artifacts_dir.glob('**/*.db'))
          
          for db_file in sorted(db_files):
            domain_folder = db_file.stem
            
            print(f"ğŸ“¦ Building: {domain_folder}")
            
            # âœ… Ğ¤Ğ˜ĞšĞ¡: ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² _site/, Ğ½Ğµ Ğ² Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºÑƒ
            site_dir = output_dir
            pages_dir = site_dir / 'pages'
            pages_dir.mkdir(exist_ok=True)
            
            shutil.copy(db_file, site_dir / f"{domain_folder}.db")
            
            conn = sqlite3.connect(str(db_file))
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            cursor.execute("PRAGMA table_info(pages)")
            all_cols = [row[1] for row in cursor.fetchall()]
            print(f"  Columns: {all_cols}")
            
            cursor.execute("SELECT * FROM pages ORDER BY id")
            pages = cursor.fetchall()
            
            print(f"  ğŸ“„ {len(pages)} pages")
            
            # Create index page
            html_content = '<!DOCTYPE html>\n'
            html_content += '<html lang="en">\n'
            html_content += '<head>\n'
            html_content += '<meta charset="UTF-8">\n'
            html_content += '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n'
            html_content += f'<title>{domain_folder}</title>\n'
            html_content += '<style>\n'
            html_content += '* { margin: 0; padding: 0; box-sizing: border-box; }\n'
            html_content += 'body { \n'
            html_content += '  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n'
            html_content += '  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n'
            html_content += '  min-height: 100vh;\n'
            html_content += '  padding: 40px 20px;\n'
            html_content += '}\n'
            html_content += '.container { max-width: 1200px; margin: 0 auto; }\n'
            html_content += 'h1 { color: white; text-align: center; margin-bottom: 40px; font-size: 2.5em; }\n'
            html_content += '.info { color: white; text-align: center; margin-bottom: 30px; }\n'
            html_content += '.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }\n'
            html_content += '.card {\n'
            html_content += '  background: white;\n'
            html_content += '  border-radius: 8px;\n'
            html_content += '  padding: 20px;\n'
            html_content += '  box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n'
            html_content += '  transition: transform 0.2s;\n'
            html_content += '}\n'
            html_content += '.card:hover { transform: translateY(-5px); }\n'
            html_content += '.card h3 { color: #333; margin-bottom: 10px; }\n'
            html_content += '.card p { color: #666; font-size: 0.9em; word-break: break-all; }\n'
            html_content += '.card a {\n'
            html_content += '  display: inline-block;\n'
            html_content += '  margin-top: 15px;\n'
            html_content += '  padding: 8px 12px;\n'
            html_content += '  background: #667eea;\n'
            html_content += '  color: white;\n'
            html_content += '  text-decoration: none;\n'
            html_content += '  border-radius: 4px;\n'
            html_content += '}\n'
            html_content += '.card a:hover { background: #764ba2; }\n'
            html_content += '</style>\n'
            html_content += '</head>\n'
            html_content += '<body>\n'
            html_content += '<div class="container">\n'
            html_content += f'<h1>ğŸ“– {domain_folder}</h1>\n'
            html_content += f'<div class="info">Total pages: {len(pages)}</div>\n'
            html_content += '<div class="grid">\n'
            
            url_col = next((c for c in all_cols if c.lower() in ['url', 'href', 'uri']), all_cols[0] if all_cols else 'id')
            
            for idx, page in enumerate(pages, 1):
              page_num = f"{idx:05d}"
              page_dict = dict(page)
              
              url = str(page_dict.get(url_col, 'N/A'))[:60]
              
              html_content += '<div class="card">\n'
              html_content += f'<h3>Page {idx}</h3>\n'
              html_content += f'<p>{url}</p>\n'
              html_content += f'<a href="pages/page-{page_num}.html">View â†’</a>\n'
              html_content += '</div>\n'
            
            html_content += '</div>\n'
            html_content += '</div>\n'
            html_content += '</body>\n'
            html_content += '</html>\n'
            
            with open(site_dir / 'index.html', 'w', encoding='utf-8') as f:
              f.write(html_content)
            
            # Create individual page files
            content_col = next((c for c in all_cols if c.lower() in ['content', 'body', 'text', 'html']), None)
            
            for idx, page in enumerate(pages, 1):
              page_num = f"{idx:05d}"
              page_file = pages_dir / f"page-{page_num}.html"
              page_dict = dict(page)
              
              url = str(page_dict.get(url_col, 'N/A'))
              content = ''
              if content_col:
                content = str(page_dict.get(content_col, ''))[:5000]
              
              page_html = '<!DOCTYPE html>\n'
              page_html += '<html lang="en">\n'
              page_html += '<head>\n'
              page_html += '<meta charset="UTF-8">\n'
              page_html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n'
              page_html += f'<title>Page {idx}</title>\n'
              page_html += '<style>\n'
              page_html += '* { margin: 0; padding: 0; box-sizing: border-box; }\n'
              page_html += 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; }\n'
              page_html += '.container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; }\n'
              page_html += '.header { border-bottom: 2px solid #667eea; margin-bottom: 30px; }\n'
              page_html += '.header h1 { color: #667eea; }\n'
              page_html += '.meta { color: #666; font-size: 0.9em; margin: 5px 0; }\n'
              page_html += '.nav a { display: inline-block; padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; }\n'
              page_html += '.nav a:hover { background: #764ba2; }\n'
              page_html += '</style>\n'
              page_html += '</head>\n'
              page_html += '<body>\n'
              page_html += '<div class="container">\n'
              page_html += '<div class="nav" style="margin-bottom: 20px;">\n'
              page_html += '<a href="../index.html">â† Back</a>\n'
              page_html += '</div>\n'
              page_html += '<div class="header">\n'
              page_html += f'<h1>Page {idx}</h1>\n'
              page_html += f'<div class="meta"><b>URL:</b> {url}</div>\n'
              page_html += '</div>\n'
              page_html += '<div style="margin-top: 30px; line-height: 1.8;">\n'
              page_html += content
              page_html += '\n</div>\n'
              page_html += '</div>\n'
              page_html += '</body>\n'
              page_html += '</html>\n'
              
              with open(page_file, 'w', encoding='utf-8') as f:
                f.write(page_html)
            
            conn.close()
            print(f"  âœ… Done\n")
          
          print("="*60)
          print("âœ… Build complete!")
          print("="*60)
          EOF

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: sites-build
          path: _site/
          retention-days: 30

  # ============================================================
  # JOB 3: DEPLOY - Upload to GitHub Pages (NO JEKYLL)
  # ============================================================
  deploy:
    name: 'ğŸš€ Deploy to Pages'
    needs: build
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sites-build
          path: _site/
      
      - name: ğŸš« Disable Jekyll processing
        run: |
          touch _site/.nojekyll
          echo "âœ… Jekyll disabled for static HTML deployment"
      
      - name: ğŸ“‚ Show structure
        run: |
          echo "Directory structure:"
          find _site -type f | head -20
      
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: âœ… Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âœ… DEPLOYMENT SUCCESSFUL                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“– Details:"
          echo "  â€¢ Domain: ${{ inputs.site_domain }}"
          echo "  â€¢ Source: ${{ inputs.source_repo }}"
          echo "  â€¢ Run ID: ${{ inputs.run_id }}"
          echo "  â€¢ Workflow: ${{ github.run_id }}"
          echo ""
          echo "ğŸŒ Live URL:"
          echo "  ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "âœ¨ Your sites are LIVE!"
          echo ""
