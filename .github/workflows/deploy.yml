name: Deploy Archive to GitHub Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Archive
        uses: actions/download-artifact@v4
        with:
          name: archive-a370f4484bdb1bff56f115d24914942a47de60c601b762df5cbb4170301695a2
          path: artifacts
          repository: KomarovAI/web-crawler
          run-id: 12290432867
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Archives
        run: |
          echo "üîì –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤..."
          find artifacts -name "*.zip" -type f 2>/dev/null | while read zip; do
            dir=$(dirname "$zip")
            echo "üì¶ –ò–∑–≤–ª–µ–∫–∞—é: $zip"
            unzip -q -o "$zip" -d "$dir" || true
            rm "$zip"
          done
          echo "‚úÖ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Process Archive & Rewrite Links
        run: |
          cat > process_archive.py << 'EOFPYTHON'
#!/usr/bin/env python3
import sqlite3
import os
import re
from pathlib import Path
from urllib.parse import urlparse, unquote

def process_archive():
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç HTML –∏–∑ –ë–î –∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ"""
    
    # –ü—É—Ç–∏
    archive_dir = Path("artifacts/archive-a370f4484bdb1bff56f115d24914942a47de60c601b762df5cbb4170301695a2/archive/callmedley.com")
    db_path = archive_dir / "callmedleycom.db"
    output_dir = Path("pages")
    
    # –°–æ–∑–¥–∞—ë–º –≤—ã—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    output_dir.mkdir(exist_ok=True)
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    cursor.execute("SELECT url, html FROM pages ORDER BY id")
    pages = cursor.fetchall()
    
    print(f"üì¶ –ù–∞–π–¥–µ–Ω–æ {len(pages)} —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
    
    # –°–æ–∑–¥–∞—ë–º –º–∞–ø–ø–∏–Ω–≥ URL -> –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å
    url_mapping = {}
    for url, _ in pages:
        parsed = urlparse(url)
        path = parsed.path.strip('/')
        
        if not path:
            local_path = "index.html"
        else:
            local_path = f"{path}/index.html"
        
        url_mapping[url] = local_path
        url_mapping[f"https://callmedley.com/{path}"] = local_path
        url_mapping[f"https://callmedley.com/{path}/"] = local_path
    
    print(f"üó∫Ô∏è  –°–æ–∑–¥–∞–Ω –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è {len(url_mapping)} URL")
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    processed = 0
    for url, html in pages:
        if not html:
            continue
            
        local_path = url_mapping.get(url)
        if not local_path:
            continue
        
        # –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –≤ HTML
        modified_html = rewrite_links(html, url, url_mapping)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        output_file = output_dir / local_path
        output_file.parent.mkdir(parents=True, exist_ok=True)
        output_file.write_text(modified_html, encoding='utf-8')
        
        processed += 1
        if processed % 50 == 0:
            print(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed}/{len(pages)} —Å—Ç—Ä–∞–Ω–∏—Ü...")
    
    conn.close()
    
    print(f"\nüéâ –ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed} —Å—Ç—Ä–∞–Ω–∏—Ü")
    print(f"üìÇ –í—Å–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_dir.absolute()}")
    
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç–æ–π index.html —Å–æ —Å–ø–∏—Å–∫–æ–º
    create_index(pages, output_dir)

def rewrite_links(html, current_url, url_mapping):
    """–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Å—ã–ª–∫–∏ —Å callmedley.com –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏"""
    
    parsed_current = urlparse(current_url)
    current_depth = len([p for p in parsed_current.path.strip('/').split('/') if p])
    
    patterns = [
        (r'href=["\']https?://callmedley\.com(/[^"\']*)["\']', 'href'),
        (r'src=["\']https?://callmedley\.com(/[^"\']*)["\']', 'src'),
        (r'url\(["\']?https?://callmedley\.com(/[^"\'\)\s]*)["\']?\)', 'css'),
    ]
    
    modified_html = html
    
    for pattern, link_type in patterns:
        def replace_link(match):
            path = match.group(1).strip('/')
            
            if not path or path.startswith('#'):
                return match.group(0)
            
            target_url = f"https://callmedley.com/{path}"
            local_path = url_mapping.get(target_url)
            
            if not local_path:
                target_url = f"https://callmedley.com/{path}/"
                local_path = url_mapping.get(target_url)
            
            if local_path:
                prefix = '../' * current_depth if current_depth > 0 else ''
                relative_path = f"{prefix}{local_path}"
                
                if link_type == 'css':
                    return f'url({relative_path})'
                else:
                    quote = match.group(0)[len(link_type)+1]
                    return f'{link_type}={quote}{relative_path}{quote}'
            
            return match.group(0)
        
        modified_html = re.sub(pattern, replace_link, modified_html)
    
    return modified_html

def create_index(pages, output_dir):
    """–°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Å—Ç–æ–π index.html —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü"""
    
    index_html = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Callmedley.com Archive - {count} Pages</title>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }}
        .container {{ max-width: 1200px; margin: 0 auto; }}
        h1 {{ 
            color: white; 
            text-align: center; 
            margin-bottom: 10px;
            font-size: 2.5em;
        }}
        .subtitle {{
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 40px;
            font-size: 1.2em;
        }}
        .grid {{ 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }}
        .card {{
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }}
        .card:hover {{
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }}
        .card h3 {{
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }}
        .url {{
            font-size: 0.85em;
            color: #666;
            margin-bottom: 12px;
            word-break: break-all;
        }}
        .btn {{
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9em;
            transition: opacity 0.2s;
        }}
        .btn:hover {{ opacity: 0.9; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>üìñ Callmedley.com Archive</h1>
        <p class="subtitle">Total pages: {count}</p>
        <div class="grid">
{cards}
        </div>
    </div>
</body>
</html>"""
    
    cards = []
    for i, (url, _) in enumerate(pages, 1):
        parsed = urlparse(url)
        path = parsed.path.strip('/')
        local_path = f"{path}/index.html" if path else "index.html"
        
        title = path.replace('/', ' ‚Ä∫ ') if path else 'Home'
        
        card = f"""            <div class="card">
                <h3>Page {i}</h3>
                <div class="url">{url}</div>
                <a href="{local_path}" class="btn">View ‚Üí</a>
            </div>"""
        cards.append(card)
    
    final_html = index_html.format(
        count=len(pages),
        cards='\n'.join(cards)
    )
    
    (output_dir / "archive-index.html").write_text(final_html, encoding='utf-8')
    print(f"üìã –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å–Ω—ã–π —Ñ–∞–π–ª: archive-index.html")

if __name__ == "__main__":
    process_archive()
EOFPYTHON

          python3 process_archive.py

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
