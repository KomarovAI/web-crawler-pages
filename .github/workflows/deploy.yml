name: Deploy Archive to GitHub Pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Archive
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: archive-a370f4484bdb1bff56f115d24914942a47de60c601b762df5cbb4170301695a2
          path: artifacts
          repository: KomarovAI/web-crawler
          run-id: 20290432867
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if Archive Downloaded
        run: |
          if [ -d "artifacts" ]; then
            echo "✅ Archive found"
            ls -la artifacts/
          else
            echo "❌ Archive not found, will create demo site"
          fi
      
      - name: Extract and Deploy
        run: |
          echo "Setting up site directory..."
          mkdir -p pages
          
          if [ -d "artifacts" ]; then
            echo "Extracting archives..."
            cd artifacts
            find . -name '*.zip' -exec unzip -q {} \;
            
            echo "Copying files to pages..."
            find . -name '*.html' -o -name '*.css' -o -name '*.js' -o -name '*.json' | head -100 | while read file; do
              mkdir -p "../pages/$(dirname "$file" | cut -d/ -f3-)"
              cp "$file" "../pages/$(dirname "$file" | cut -d/ -f3-)/" 2>/dev/null || true
            done
            
            cd ..
          fi
          
          # Ensure index.html exists
          if [ ! -f "pages/index.html" ]; then
            echo "Creating index.html..."
            cat > pages/index.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archive</title>
  <style>
    body { font-family: Arial; background: #f5f5f5; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <h1>✅ Site Deployed Successfully!</h1>
    <p>The archive has been deployed to GitHub Pages.</p>
  </div>
</body>
</html>
HTMLEOF
          fi
      
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
