name: ðŸ’¨ Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      rollback_commit:
        description: 'Commit SHA to rollback to'
        required: false
      rollback_to_previous:
        description: 'Rollback to previous deployment'
        required: false
        type: boolean
        default: true

jobs:
  analyze:
    name: ðŸ” Analyze Current State
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      last_deployment: ${{ steps.info.outputs.last_deployment }}
      deployment_time: ${{ steps.info.outputs.deployment_time }}
      can_rollback: ${{ steps.info.outputs.can_rollback }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: ðŸ” Get Last Deployment Info
        id: info
        run: |
          echo "Analyzing deployment history..."
          
          # Get last successful deployment
          if [ -f ".deployment/info.json" ]; then
            echo "can_rollback=true" >> $GITHUB_OUTPUT
            cat .deployment/info.json
            last_deployment=$(cat .deployment/info.json | grep deployment_id | head -1)
            echo "last_deployment=$last_deployment" >> $GITHUB_OUTPUT
          else
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            echo "No previous deployment found"
          fi

  rollback:
    name: ðŸ’ª Execute Rollback
    needs: [analyze]
    if: needs.analyze.outputs.can_rollback == 'true'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.rollback_commit || 'main' }}

      - name: ðŸ’ª Rollback to Previous Commit
        if: inputs.rollback_to_previous == true && inputs.rollback_commit == ''
        run: |
          echo "ðŸ’ª Rolling back to previous deployment..."
          
          # Get previous commit
          git log --oneline | head -5
          PREV_COMMIT=$(git log --oneline | grep -E "Deploy|deploy" | head -2 | tail -1 | awk '{print $1}')
          
          if [ -z "$PREV_COMMIT" ]; then
            PREV_COMMIT=$(git log --oneline | head -2 | tail -1 | awk '{print $1}')
          fi
          
          echo "Previous commit: $PREV_COMMIT"
          git checkout $PREV_COMMIT -- sites/ 2>/dev/null || echo "No previous sites directory"

      - name: ðŸ“‹ Create Rollback Marker
        run: |
          mkdir -p .deployment
          cat > .deployment/rollback.json << 'EOF'
          {
            "rollback_executed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "rollback_by": "${{ github.actor }}",
            "rollback_workflow_run": "${{ github.run_id }}",
            "original_commit": "$(git rev-parse HEAD)",
            "reason": "Emergency rollback executed"
          }
          EOF
          cat .deployment/rollback.json

      - name: ðŸ’¾ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ’¾ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ðŸš€ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: ðŸš€ Deploy Rollback
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    name: ðŸ“¢ Send Notification
    needs: [rollback]
    if: always()
    runs-on: ubuntu-24.04
    
    steps:
      - name: ðŸ“¢ Rollback Summary
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ðŸ’¨ EMERGENCY ROLLBACK EXECUTED                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“„ Rollback Details:
            â€¢ Executed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            â€¢ Executed by: ${{ github.actor }}
            â€¢ Workflow Run: ${{ github.run_id }}
            â€¢ Repository: ${{ github.repository }}
          
          ðŸ› ï¸  What to do next:
            1. Check the Pages deployment status
            2. Investigate what caused the deployment issue
            3. Fix the problem in your code
            4. Re-run the deploy workflow when ready
          
          ðŸ“ Logs:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                      STAY SAFE!                            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF
